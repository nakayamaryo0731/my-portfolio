---
import Card from "./Card/index.astro";
import { EXTERNAL_URLS } from "../lib/constants";
---

<Card colSpan="md:col-span-2" rowSpan="md:row-span-3" title="Posts">
  <div class="flex flex-col gap-2 overflow-y-auto max-h-56 md:max-h-72 pr-1" id="posts-container">
    <p class="text-sm text-gray-500">Loading posts...</p>
  </div>
  <div class="flex gap-4 mt-4 text-xs">
    <a href="/posts" class="text-white hover:underline font-medium">
      All Posts â†’
    </a>
    <a href="/blog" class="text-primary-400 hover:underline">
      Blog
    </a>
    <a href={EXTERNAL_URLS.zenn} target="_blank" class="text-blue-400 hover:underline">
      Zenn
    </a>
    <a href={EXTERNAL_URLS.note} target="_blank" class="text-green-400 hover:underline">
      note
    </a>
  </div>
</Card>

<script>
  import type { PostItem } from "../lib/types";
  import { formatDateJP, getPostTarget, renderSourceBadge } from "../lib/helpers";

  async function loadPosts() {
    const container = document.getElementById("posts-container");
    if (!container) return;

    try {
      const response = await fetch("/api/posts");
      if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);

      const posts: PostItem[] = await response.json();

      if (posts.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">No posts yet</p>';
        return;
      }

      container.innerHTML = posts.slice(0, 10).map((item) => `
        <a
          href="${item.link}"
          target="${getPostTarget(item.source)}"
          class="flex justify-between items-center border-b border-dashed border-neutral-700 pb-1 hover:text-neutral-400 transition-colors"
        >
          <div class="flex items-center gap-2">
            ${renderSourceBadge(item.source)}
            <span class="text-sm line-clamp-1">${item.title}</span>
          </div>
          <time class="text-xs text-gray-500 whitespace-nowrap ml-2">
            ${formatDateJP(item.pubDate)}
          </time>
        </a>
      `).join("");
    } catch (error) {
      container.innerHTML = '<p class="text-sm text-gray-500">Failed to load posts</p>';
    }
  }

  loadPosts();
</script>
