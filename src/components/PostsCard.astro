---
import Card from "./Card/index.astro";
import Parser from "rss-parser";
import { getCollection } from "astro:content";

const parser = new Parser();

type PostItem = {
  title: string;
  link: string;
  pubDate: Date;
  source: "Zenn" | "note" | "Blog";
};

const posts: PostItem[] = [];

// Internal blog posts
const blogPosts = await getCollection("blog", ({ data }) => !data.draft);
blogPosts.forEach((post) => {
  posts.push({
    title: post.data.title,
    link: `/blog/${post.id}`,
    pubDate: post.data.pubDate,
    source: "Blog",
  });
});

// Zenn
try {
  const zennFeed = await parser.parseURL("https://zenn.dev/r0nr0n/feed");
  zennFeed.items?.forEach((item) => {
    posts.push({
      title: item.title || "",
      link: item.link || "",
      pubDate: new Date(item.pubDate || ""),
      source: "Zenn",
    });
  });
} catch (e) {
  // Zennの記事がない場合はスキップ
}

// note
try {
  const noteFeed = await parser.parseURL("https://note.com/ron0731/rss");
  noteFeed.items?.forEach((item) => {
    posts.push({
      title: item.title || "",
      link: item.link || "",
      pubDate: new Date(item.pubDate || ""),
      source: "note",
    });
  });
} catch (e) {
  // noteの記事がない場合はスキップ
}

// 日付でソート（新しい順）
posts.sort((a, b) => b.pubDate.getTime() - a.pubDate.getTime());

const formatDate = (date: Date) => {
  return date.toLocaleDateString("ja-JP", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};

const sourceStyles = {
  "Blog": "bg-primary-500 text-white",
  "Zenn": "bg-blue-500 text-white",
  "note": "bg-green-600 text-white",
};
---

<Card colSpan="md:col-span-2" rowSpan="md:row-span-3" title="Posts">
  <div class="flex flex-col gap-2">
    {posts.length > 0 ? (
      posts.slice(0, 6).map((item) => (
        <a
          href={item.link}
          target={item.source === "Blog" ? "_self" : "_blank"}
          class="flex justify-between items-center border-b border-dashed border-neutral-700 pb-1 hover:text-neutral-400 transition-colors"
        >
          <div class="flex items-center gap-2">
            <span class={`text-xs px-1.5 py-0.5 rounded ${sourceStyles[item.source]}`}>
              {item.source}
            </span>
            <span class="text-sm line-clamp-1">{item.title}</span>
          </div>
          <time class="text-xs text-gray-500 whitespace-nowrap ml-2">
            {formatDate(item.pubDate)}
          </time>
        </a>
      ))
    ) : (
      <p class="text-sm text-gray-500">No posts yet</p>
    )}
  </div>
  <div class="flex gap-4 mt-4 text-xs">
    <a href="/posts" class="text-white hover:underline font-medium">
      All Posts →
    </a>
    <a href="/blog" class="text-primary-400 hover:underline">
      Blog
    </a>
    <a href="https://zenn.dev/r0nr0n" target="_blank" class="text-blue-400 hover:underline">
      Zenn
    </a>
    <a href="https://note.com/ron0731" target="_blank" class="text-green-400 hover:underline">
      note
    </a>
  </div>
</Card>
